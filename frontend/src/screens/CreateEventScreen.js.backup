import React, { useState } from 'react';
import { View, Text, TextInput, TouchableOpacity, StyleSheet, ScrollView, Platform, Alert, ImageBackground, Dimensions } from 'react-native';
import api from '../api/api';
import AsyncStorage from '@react-native-async-storage/async-storage';

const { width } = Dimensions.get('window');

const CreateEventScreen = ({ navigation }) => {
  const [formData, setFormData] = useState({
    name: '',
    description: '',
    date: '',
    type: 'Normal', // Default type
    eligibility: 'Open to all',
    price: '',    // New Field
    stock: ''     // New Field
  });

  const handleChange = (name, value) => {
    setFormData(prev => ({ ...prev, [name]: value }));
  };

  const handleSubmit = async () => {
    // 1. Basic Validation
    if (!formData.name || !formData.date || !formData.description) {
        alert("Please fill in Name, Date, and Description");
        return;
    }

    // 2. Merchandise Validation
    if (formData.type === 'Merchandise' && (!formData.price || !formData.stock)) {
        alert("Merchandise must have Price and Stock!");
        return;
    }

    try {
      const token = await AsyncStorage.getItem('token');
      
      const payload = {
        ...formData,
        // Convert numbers
        price: Number(formData.price) || 0,
        stock: Number(formData.stock) || 0,
        // Date formatting
        startdate: new Date(formData.date), 
        enddate: new Date(formData.date),
        registrationdeadline: new Date(formData.date)
      };

      await api.post('/events', payload, {
        headers: { Authorization: `Bearer ${token}` }
      });

      if (Platform.OS === 'web') {
        window.alert('Success: Event Created!');
        navigation.replace('Home');
      } else {
        Alert.alert('Success', 'Event Created!');
        navigation.replace('Home');
      }

    } catch (error) {
      console.error("Creation Error:", error);
      const msg = error.response?.data?.message || "Failed to create event.";
      alert(msg);
    }
  };

  return (
    <ImageBackground
      source={{ uri: 'https://images.unsplash.com/photo-1492684223066-81342ee5ff30?q=80&w=2070&auto=format&fit=crop' }}
      style={styles.backgroundImage}
      blurRadius={2}
    >
      <View style={styles.overlay} />
      
      <ScrollView contentContainerStyle={styles.container}>
        <View style={styles.headerContainer}>
          <Text style={styles.emoji}>üéâ</Text>
          <Text style={styles.title}>Create Amazing Event</Text>
          <Text style={styles.subtitle}>Launch your event or merch store</Text>
        </View>

        <View style={styles.form}>
        
        {/* --- Event Type Selector --- */}
        <Text style={styles.label}>üé´ Event Type</Text>
        <View style={styles.typeContainer}>
          <TouchableOpacity 
            style={[styles.typeButton, formData.type === 'Normal' && styles.activeTypeNormal]}
            onPress={() => handleChange('type', 'Normal')}
          >
            <Text style={[styles.typeEmoji, formData.type === 'Normal' && styles.activeEmoji]}>üé™</Text>
            <Text style={[styles.typeText, formData.type === 'Normal' && styles.activeTypeText]}>Normal Event</Text>
          </TouchableOpacity>
          <TouchableOpacity 
            style={[styles.typeButton, formData.type === 'Merchandise' && styles.activeTypeMerch]}
            onPress={() => handleChange('type', 'Merchandise')}
          >
            <Text style={[styles.typeEmoji, formData.type === 'Merchandise' && styles.activeEmoji]}>üëï</Text>
            <Text style={[styles.typeText, formData.type === 'Merchandise' && styles.activeTypeText]}>Merchandise</Text>
          </TouchableOpacity>
        </View>

        <Text style={styles.label}>‚ú® Event Name</Text>
        <TextInput 
          style={styles.input} 
          placeholder={formData.type === 'Normal' ? "Ex: Hackathon 2026" : "Ex: Felicity T-Shirt"}
          value={formData.name}
          onChangeText={(text) => handleChange('name', text)}
        />

        <Text style={styles.label}>üìÖ Date (YYYY-MM-DD)</Text>
        <TextInput 
          style={styles.input} 
          placeholder="2026-03-20" 
          value={formData.date}
          onChangeText={(text) => handleChange('date', text)}
        />

        {/* --- CONDITIONAL FIELDS For Merchandise --- */}
        {formData.type === 'Merchandise' && (
          <View style={styles.row}>
            <View style={{flex: 1, marginRight: 10}}>
              <Text style={styles.label}>üí∞ Price (‚Çπ)</Text>
              <TextInput 
                style={styles.input} 
                placeholder="499" 
                placeholderTextColor="#999"
                keyboardType="numeric"
                value={formData.price}
                onChangeText={(text) => handleChange('price', text)}
              />
            </View>
            <View style={{flex: 1}}>
              <Text style={styles.label}>üì¶ Stock (Qty)</Text>
              <TextInput 
                style={styles.input} 
                placeholder="100" 
                placeholderTextColor="#999"
                keyboardType="numeric"
                value={formData.stock}
                onChangeText={(text) => handleChange('stock', text)}
              />
            </View>
          </View>
        )}

        <Text style={styles.label}>üìù Description</Text>
        <TextInput 
          style={[styles.input, styles.textArea]} 
          placeholder="Tell us about your event..." 
          placeholderTextColor="#999"
          multiline
          numberOfLines={4}
          value={formData.description}
          onChangeText={(text) => handleChange('description', text)}
        />

        <TouchableOpacity style={styles.button} onPress={handleSubmit}>
          <Text style={styles.buttonText}>üöÄ Publish {formData.type}</Text>
        </TouchableOpacity>

        <TouchableOpacity style={styles.cancelButton} onPress={() => navigation.goBack()}>
          <Text style={styles.cancelText}>‚Üê Cancel</Text>
        </TouchableOpacity>

      </View>
    </ScrollView>
    </ImageBackground>
  );
};

const styles = StyleSheet.create({
  backgroundImage: { flex: 1 },
  overlay: {
    ...StyleSheet.absoluteFillObject,
    backgroundColor: 'rgba(0, 0, 0, 0.65)',
  },
  container: { 
    flexGrow: 1,
    padding: 20,
    alignItems: 'center',
    paddingTop: 40
  },
  
  headerContainer: {
    alignItems: 'center',
    marginBottom: 30
  },
  emoji: { fontSize: 60, marginBottom: 10 },
  title: { 
    fontSize: Platform.OS === 'web' ? 36 : 28,
    fontWeight: '900',
    marginBottom: 8,
    color: '#fff',
    textAlign: 'center',
    textShadowColor: '#fb5607',
    textShadowRadius: 15,
    letterSpacing: 1
  },
  subtitle: {
    fontSize: 16,
    color: '#fff',
    fontWeight: '600',
    opacity: 0.9
  },
  
  form: { 
    width: Platform.OS === 'web' ? 550 : '100%',
    backgroundColor: 'rgba(255, 255, 255, 0.95)',
    padding: 30,
    borderRadius: 20,
    shadowColor: '#000',
    shadowOpacity: 0.3,
    shadowRadius: 15,
    elevation: 10
  },
  
  label: { 
    fontSize: 16,
    fontWeight: '700',
    marginBottom: 8,
    color: '#333',
    marginTop: 5
  },
  input: { 
    borderWidth: 2,
    borderColor: '#e0e0e0',
    padding: 14,
    borderRadius: 12,
    marginBottom: 15,
    fontSize: 16,
    backgroundColor: '#f9f9f9',
    color: '#333'
  },
  textArea: { 
    height: 100,
    textAlignVertical: 'top'
  },
  
  // Type Selector Styles
  typeContainer: { 
    flexDirection: 'row',
    marginBottom: 20,
    gap: 15
  },
  typeButton: { 
    flex: 1,
    padding: 18,
    borderWidth: 2,
    borderColor: '#e0e0e0',
    alignItems: 'center',
    borderRadius: 15,
    backgroundColor: '#f9f9f9'
  },
  activeTypeNormal: { 
    backgroundColor: '#8338ec',
    borderColor: '#8338ec',
    shadowColor: '#8338ec',
    shadowOpacity: 0.4,
    shadowRadius: 10,
    elevation: 5
  },
  activeTypeMerch: { 
    backgroundColor: '#ff9800',
    borderColor: '#ff9800',
    shadowColor: '#ff9800',
    shadowOpacity: 0.4,
    shadowRadius: 10,
    elevation: 5
  },
  typeEmoji: { 
    fontSize: 32,
    marginBottom: 8
  },
  activeEmoji: {
    transform: [{ scale: 1.1 }]
  },
  typeText: { 
    fontSize: 15,
    color: '#666',
    fontWeight: '600'
  },
  activeTypeText: { 
    color: 'white',
    fontWeight: 'bold'
  },
  
  row: { 
    flexDirection: 'row',
    justifyContent: 'space-between'
  },

  button: { 
    backgroundColor: '#fb5607',
    padding: 18,
    borderRadius: 15,
    alignItems: 'center',
    marginTop: 10,
    shadowColor: '#fb5607',
    shadowOpacity: 0.5,
    shadowRadius: 15,
    elevation: 8
  },
  buttonText: { 
    color: 'white',
    fontWeight: 'bold',
    fontSize: 18,
    letterSpacing: 1
  },
  cancelButton: { 
    marginTop: 15,
    alignItems: 'center',
    padding: 10
  },
  cancelText: { 
    color: '#fff',
    fontSize: 16,
    fontWeight: '600'
  }
});

export default CreateEventScreen;